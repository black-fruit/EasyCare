"use strict";const yargs=require("yargs/yargs"),{hideBin:hideBin}=require("yargs/helpers"),{app:app,Tray:Tray,Menu:Menu}=require("electron"),path=require("path"),fs=require("fs");global.argv=yargs(hideBin(process.argv)).argv,global.debug=global.argv.debug,global.useSentry="false"!==global.argv.sentry,global.env=global.argv.env||"",global.isDev="dev"===global.argv.mode,global.APP_PATH=__dirname,global.soursePath=global.isDev?"src":"dist",global.easicareStart=Date.now(),global.store=require(`./${global.soursePath}/base/store`),global.config=require("./config")(global.argv),global.config.APP_PATH=__dirname,global.log=require(`./${global.soursePath}/base/log`),global.childProcesses=[],global.zoom=1,global.MessageCenter=null;const{initSentry:initSentry}=require(`./${global.soursePath}/base/sentry`);initSentry();const reportError=require(`./${global.soursePath}/components/capm`).reportError;app.commandLine.appendSwitch("touch-events","enabled"),app.commandLine.appendSwitch("enable-gpu-rasterization","true"),app.commandLine.appendSwitch("enable-native-gpu-memory-buffers","true"),app.commandLine.appendSwitch("high-dpi-support",1),app.commandLine.appendSwitch("force-device-scale-factor",1);const args=[],PROTOCOL="easicare";function handleArgv(e){const a=app.isPackaged?1:2,o=e.find(((e,o)=>o>=a&&e.startsWith("easicare:")));if(o){const e=new URL(o),{searchParams:a}=e;global.config.loginType=a.get("loginType")||"",global.config.token=a.get("token")||""}}app.isPackaged||args.push(path.resolve(process.argv[1])),args.push("--"),handleArgv(process.argv),!app.isPackaged&&app.setAsDefaultProtocolClient(PROTOCOL,process.execPath,args),app.requestSingleInstanceLock()?app.on("second-instance",((e,a,o)=>{handleArgv(a);const r=yargs(hideBin(a)).argv;switch(config.loginType){case"tencent-sso":clearCache(),global.MessageCenter.emit("app-restart");break;default:"en5"===r.from&&r.uid&&r.uid!==global.config.uid?(clearCache(),global.config.from=r.from,global.config.uid=r.uid,global.MessageCenter.emit("app-restart")):global.MessageCenter&&global.MessageCenter.emit("tray-show-main-window")}})):app.exit(0);const clearCache=()=>{var e=app.getPath("userData");try{var a=path.join(e,"Cookies");fs.existsSync(a)&&fs.unlinkSync(a)}catch(e){log.error(e)}};clearCache(),process.on("uncaughtException",(function(e){const a=e.code;if(["ECONNREFUSED","ECONNRESET"].indexOf(a)>-1)return!1;console.error("uncaughtException: ",e)})),app.on("gpu-process-crashed",(function(){log.error("GPU进程崩溃，程序退出"),app.exit(0)})),app.on("window-all-closed",(function(){"darwin"!=process.platform&&app.quit()})),app.on("before-quit",(function(){const e=global.childProcesses;if(e.length>0)for(let a=0;a<e.length;++a)try{e[a].kill()}catch(e){console.log(e),log.error(e)}}));var tray=null;app.on("ready",(function(){global.MessageCenter=require(`./${global.soursePath}/components/MessageCenter`),setTimeout((()=>{try{global.MessageCenter.emit("app-start")}catch(e){console.log(e)}}),350),tray=new Tray(`${APP_PATH}/dist/pages/theme/images/pc/care.ico`);const e=Menu.buildFromTemplate([{label:"显示主窗口",type:"normal",click:function(){global.MessageCenter.emit("tray-show-main-window")}},{label:"退出",type:"normal",click:function(){global.MessageCenter.emit("tray-app-quit")}}]);tray.setToolTip("班级优化大师"),tray.setContextMenu(e),tray.on("click",(function(){global.MessageCenter.emit("tray-show-login-window")}))})),process.on("uncaughtException",(e=>{console.error("uncaughtException: ",e)}));
var fs=require("fs"),path=require("path"),Event=require("../base/events"),log=require("../base/log"),cp=require("child_process"),app=require("electron").app;function Updater(){var t="";try{t=app.getPath("cache")}catch(e){log.error("[Updater.js][error]",e);try{t=app.getPath("temp")}catch(t){log.error("[Updater.js][error]",t)}}t&&(this.downloadPath=path.join(t,"easicare-pc","update"),this.downloadedListPath=path.join(t,"easicare-pc","update","version.txt"),this.init())}Updater.prototype={init:function(){this.initSuccessfull=!1;var t=[],e=this.downloadPath;try{for(;!1===fs.existsSync(e);)t.push(path.basename(e)),e=path.join(e,"..");for(;t.length>0;){var i=t.pop();e=path.join(e,i),fs.mkdirSync(e)}}catch(t){log.error(t)}fs.existsSync(this.downloadPath)?this.initSuccessfull=!0:this.initSuccessfull=!1},setVersionInfo:function(t){this.currentVersion=t.currentVersion,this.futureVersion=t.futureVersion,this.hasUpdatePackages=t.hasUpdatePackages,this.checkUpdate()},checkUpdate:function(){var t=!1;if(!1===this.initSuccessfull)return t;if(!0===this.hasUpdatePackages)if(this.checkPackageFileExists())if(this.checkDownloadedList())this.filePath=this.getDownloadedFilePath();else{var e=fs.readdirSync(this.downloadPath),i=this.downloadPath,s=this.futureVersion;e.forEach((function(t){t.indexOf(s)>-1&&fs.unlinkSync(path.join(i,t))})),t=!0}else t=!0;return t},checkPackageFileExists:function(){var t=!1,e=this.futureVersion;if(fs.existsSync(this.downloadPath)){var i=fs.readdirSync(this.downloadPath);0===i.length?t=!1:i.forEach((function(i){i.indexOf(e)>-1&&(t=!0)}))}return t},checkDownloadedList:function(){var t=!1,e=this.futureVersion;if(fs.existsSync(this.downloadedListPath)){var i=fs.readFileSync(this.downloadedListPath);void 0!==JSON.parse(i)[e]&&(t=!0)}else{var s=JSON.stringify({});fs.writeFileSync(this.downloadedListPath,s)}return t},getDownloadedFilePath:function(){var t=void 0,e=this.futureVersion;if(fs.existsSync(this.downloadedListPath)){var i=fs.readFileSync(this.downloadedListPath);t=JSON.parse(i)[e]}return t},updateDownloadedList:function(t){var e=this.futureVersion,i={};if(fs.existsSync(this.downloadedListPath)){var s=fs.readFileSync(this.downloadedListPath),a=JSON.parse(s);a[e]=t,i=a}else i[e]=t;this.filePath=t;var r=JSON.stringify(i);fs.writeFileSync(this.downloadedListPath,r)},installNewPackage:function(){if(void 0===this.filePath)return!1;var t=path.join(this.downloadPath,this.filePath);(0,cp.exec)(t,(function(t,e,i){console.log("err",t),console.log("stdout",e),console.log("stderr",i)}))}},module.exports=new Updater;
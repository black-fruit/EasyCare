"use strict";const BufferStack=function(e=1024,t=4,l=0){let o=l,n=t,c=0,r=0,f=0,i=e,a=Buffer.alloc(i),u="readUInt32BE",s="writeUInt32LE",y=null;function p(){let e=0;return e=c===i&&r>=f?i:r>=f?r-f:i-f+r,e!==c&&log.info("dataLen长度不合法"),e}this.readIntMethod=u,this.writeIntMethod=s,this.setReadIntBE=function(e=32){e=Number(e);return u="readUInt"+e+"BE",s="writeUInt"+e+"BE",this},this.setReadIntLE=function(e=32){e=Number(e);return u="readUInt"+e+"LE",s="writeUInt"+e+"LE",this},this.putBuffer=function(e,t,l){if(void 0!==e)try{let s=0,h=e.length;if(i-c<h){let t=Math.ceil((c+h)/i)*i,l=Buffer.alloc(t);if(r<f){let e=i-f;a.copy(l,0,f,f+e),a.copy(l,e,0,r)}else a.copy(l,0,f,r);i=t,a=l,l=null,f=0,r=c,e.copy(a,r,s,s+h),c+=h,r+=h}else if(r+h>i){let t=i-r;t<0&&log.info("bufferTailLength < 0 ");let l=s+t;e.copy(a,r,s,l),r=0,s=l;let o=h-t;e.copy(a,r,s,s+o),c+=h,r+=o}else e.copy(a,r,s,s+h),r>i&&log.info("程序有漏洞"),c+=h,r+=h;!function(e,t){clearInterval(y),y=setInterval((()=>{p()<n&&(console.log("数据长度小于包头规定长度，不能解析。等待数据......"),clearInterval(y));let l=i-f,s=0,h=Buffer.alloc(n);if(l<n){a.copy(h,0,f,i);let e=n-l;a.copy(h,l,0,e),s=h[u]()}else a.copy(h,0,f,f+n),s=h[u]();if(s+=o,p()<s)log.info("已有body数据长度小于包头定于body的长度，等待数据......"),clearInterval(y);else{let l=Buffer.alloc(s);if(i-f<s){let e=i-f;a.copy(l,0,f,e+f);let t=s-e;a.copy(l,e,0,t),f=t}else a.copy(l,0,f,f+s),f+=s;try{c-=l.length,f===r&&clearInterval(y),e&&e(l)}catch(e){t&&t(e)}}}),20)}(t,l)}catch(e){console.log(e)}}};module.exports=exports=BufferStack;
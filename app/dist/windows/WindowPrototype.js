var{BrowserWindow:BrowserWindow}=require("electron"),CookieMgr=require("cookie"),_=require("lodash"),Event=require("../base/events"),SystemInfo=require("../components/SystemInfo"),path=require("path"),interceptCookies=config.interceptCookies;function windowPrototype(){this.open=function(e){var n=this;if(n.isReadyToShow=!1,null!==this.instance)return e&&e(),!1;try{console.log(`open ${n.name}`);const s=this.state;void 0===s.webPreferences&&(s.webPreferences={}),s.webPreferences.webSecurity=!1,s.webPreferences.preload=path.resolve(path.join(global.APP_PATH,`/${global.soursePath}/windows/preload.js`));let i={width:parseInt(s.width*SystemInfo.zooms[0],10),height:parseInt(s.height*SystemInfo.zooms[0],10)};this.instance=new BrowserWindow({...s,...i});var t=`${this.instance.webContents.getUserAgent()} ${config.appName}/${config.version}`;this.instance.webContents.setUserAgent(t),this.instance.loadURL(this.url,{extraHeaders:"pragma: no-cache\n",userAgent:t}),this.instance.name=s.title,this.instance.width=i.width,this.instance.height=i.height,this.instance.setMaximizable(!1),this.closable=!1,this.currentScreen=0,this.instance.webContents.on("dom-ready",(function(){n.isReadyToShow=!0,Event.emit(`${n.name}-ready-to-show`);try{e&&e()}catch(e){console.log("open -> error",e)}})),this.instance.on("show",(function(){Event.emit(`${n.name}-show`),n.instance.setAlwaysOnTop(!0)})),this.instance.on("close",(function(e){var t=n.closable;Event.emit(`${n.name}-close`,e,t)})),this.instance.on("closed",(function(){Event.emit(`${n.name}-closed`)})),this.instance.on("minimize",(function(){Event.emit(`${n.name}-minimize`)})),this.instance.webContents.on("did-finish-load",(function(){Event.emit(`${n.name}-webContents-did-finish-load`)})),this.instance.webContents.on("did-fail-load",(function(){Event.emit(`${n.name}-webContents-did-fail-load`)})),this.instance.on("move",(function(e){if(Event.emit(`${n.name}-moved`,e),!n.instance.isMinimized()&&n.instance.isVisible()&&SystemInfo.displays.length>1){const e=n.instance.getPosition(),t=n.instance.getSize();SystemInfo.displays.forEach((function(i,o){if(n.currentScreen!==o&&i.bounds.x<e[0]+t[0]/2&&e[0]+t[0]/2<i.bounds.x+i.bounds.width&&i.bounds.y<e[1]+t[1]/2&&e[1]+t[1]/2<i.bounds.y+i.bounds.height){const e=parseInt(s.width*SystemInfo.zooms[o],10),t=parseInt(s.height*SystemInfo.zooms[o],10);n.instance.setSize(e,t),n.instance.setContentSize(e,t),n.instance.webContents.setZoomFactor(SystemInfo.zooms[o]),n.instance.setAlwaysOnTop(!0),n.currentScreen=o}}))}})),this.instance.on("resize",(function(e){Event.emit(`${n.name}-resize`,e),n.instance&&(n.instance.isOnResizing=!0,n.instance.setAlwaysOnTop(!1)),clearTimeout(n.completeResizeProcess),n.completeResizeProcess=setTimeout((function(){n.instance&&(n.instance.isOnResizing=!1)}),500)})),this.instance.webContents.session.removeAllListeners("will-download"),this.instance.webContents.session.on("will-download",(function(){Event.emit(`${n.name}-webContents-session-will-download`)}));const o=this.instance.webContents.session.webRequest;return o.onBeforeSendHeaders((function(e,n){let{requestHeaders:i}=e;i=Object.assign({},i,{Referer:s.referer||config.referer,"User-Agent":t}),n({requestHeaders:i})})),o.onHeadersReceived(((e,n)=>{let t=e.responseHeaders["Set-Cookie"];if(void 0!==t)for(let e=0;e<t.length;++e){let n=t[e],s=CookieMgr.parse(n);const i=_.keys(s)[0],o=s[i];try{if(interceptCookies.indexOf(i)>-1){const e=`\n                                                    window.localStorage.setItem('${i}', '${o}');\n                                                `;this.instance.webContents.executeJavaScript(e)}}catch(e){console.log(e)}}n(e)})),setTimeout((()=>{!0!==n.isReadyToShow&&n.reOpen()}),1e4),!0}catch(e){return Event.emit("error",e),!1}},this.reOpen=function(){if(null===this.instance)return!1;try{this.instance.destroy(),this.instance=null,this.open()}catch(e){return Event.emit("error",e),!1}},this.show=function(){if(null===this.instance)return!1;try{return this.instance.show(),global.argv.devtool&&(require("devtron").install(),this.instance.webContents.openDevTools()),!0}catch(e){return Event.emit("error",e),!1}},this.hide=function(){if(null===this.instance)return!1;try{return this.instance.hide(),!0}catch(e){return Event.emit("error",e),!1}},this.miniMum=function(){if(null===this.instance)return Promise.resolve();return new Promise(((e,n)=>{try{const n=this;this.instance.webContents.executeJavaScript('$("html").css({"opacity": 0})',!0,(()=>{n.instance.setSize(0,0),e()}))}catch(e){Event.emit("error",e),n()}}))},this.close=function(){if(null===this.instance)return!1;this.closable=!0;try{var e=this;this.instance.hide(),this.instance.close(),null!==e.instance&&e.instance.destroy&&(e.instance.destroy(),e.instance=null)}catch(e){return Event.emit("error",e),!1}},this.setToAlwaysShowOnTopInterval=function(e){var n=this;if(null===this.instance)return!0;n.instance.setAlwaysOnTop(!0);try{return this.showInterval&&clearInterval(this.showInterval),this.showInterval=setInterval((function(){try{if(null===n.instance)return clearInterval(n.showInterval),!0;if(e&&e.length>0)for(var t in e){var s=e[t];try{if(s.instance&&s.instance.isVisible())return!0}catch(n){console.log("this.showInterval -> error",n),e.splice(t,1)}}if(!n.instance)return clearInterval(n.showInterval),!0;n.instance.isVisible()?(!0!==n.instance.isOnResizing&&n.instance.setAlwaysOnTop(!0),n.instance.showInactive()):n.instance.setAlwaysOnTop(!1)}catch(e){console.log("-----error"),console.log("---intervalError:",e),Event.emit("interval-error",e),clearInterval(n.showInterval)}}),1e3),!0}catch(e){return console.log("error:",e),Event.emit("error",e),!1}},this.setToAlwaysShowOnTop=function(){if(null===this.instance)return!0;try{this.instance.setAlwaysOnTop(!0)}catch(e){return Event.emit("error",e),!1}},this.setSize=function(e){if(null===this.instance)return!0;try{this.instance.setSize(e.width,e.height)}catch(e){return Event.emit("error",e),!1}},this.setAttr=function(e,n){if(null===this.instance)return!0;try{this.instance[e]=n}catch(e){return Event.emit("error",e),!1}},this.send=function(e,n){if(null===this.instance)return!0;try{this.instance.webContents.send(e,n)}catch(e){return Event.emit("error",e),!1}},this.getInstance=function(){return this.instance},this.isEmpty=function(){return null===this.instance},this.stopAlwaysShowOnTopInterval=function(){this.showInterval&&(clearInterval(this.showInterval),this.showInterval=null)},this.blurWebView=function(){return this.instance.blurWebView()}}module.exports=windowPrototype;